name: Build Test

# Manual workflow trigger only - for development testing
on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWRT version to test'
        required: true
        default: '24.10'
        type: choice
        options:
          - '23.05'
          - '24.10'
      verbose:
        description: 'Verbose build output'
        required: false
        default: false
        type: boolean

# Environment variables
env:
  OPENWRT_23_05_VERSION: "23.05.3"
  OPENWRT_24_10_VERSION: "24.10.0"
  SDK_BASE_URL: "https://downloads.openwrt.org/releases"
  TARGET_ARCH: "x86_64"
  TARGET: "x86"
  SUBTARGET: "64"
  SDK_NAME: "x86-64"

jobs:
  build-test:
    name: Build Test - OpenWRT ${{ github.event.inputs.openwrt_version }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          # Install required packages for Ubuntu
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            python3-setuptools \
            rsync \
            swig \
            unzip \
            zlib1g-dev \
            file \
            wget \
            time

      - name: Download OpenWRT SDK
        run: |
          # Set version variables
          if [ "${{ github.event.inputs.openwrt_version }}" = "23.05" ]; then
            OPENWRT_VERSION="$OPENWRT_23_05_VERSION"
          else
            OPENWRT_VERSION="$OPENWRT_24_10_VERSION"
          fi
          
          echo "Downloading OpenWRT $OPENWRT_VERSION SDK for $TARGET_ARCH..."
          
          # Download SDK
          SDK_URL="${SDK_BASE_URL}/${OPENWRT_VERSION}/targets/${TARGET}/${SUBTARGET}/openwrt-sdk-${SDK_NAME}-generic_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          
          echo "SDK URL: $SDK_URL"
          
          # Download and extract SDK
          wget -q "$SDK_URL" -O openwrt-sdk.tar.xz
          
          if [ ! -f openwrt-sdk.tar.xz ]; then
            echo "Failed to download SDK from $SDK_URL"
            exit 1
          fi
          
          # Extract SDK
          tar -xf openwrt-sdk.tar.xz
          
          # Find SDK directory
          SDK_DIR=$(find . -maxdepth 1 -name "openwrt-sdk-*" -type d | head -1)
          if [ -z "$SDK_DIR" ]; then
            echo "Failed to find SDK directory"
            exit 1
          fi
          
          echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV
          echo "Found SDK directory: $SDK_DIR"

      - name: Setup SDK environment
        run: |
          cd $SDK_DIR
          
          # Update feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # Configure for minimal build
          cat > .config << EOF
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_HAS_SUBTARGETS=y
          CONFIG_HAS_DEVICES=y
          CONFIG_TARGET_BOARD="x86"
          CONFIG_TARGET_SUBTARGET="64"
          CONFIG_TARGET_PROFILE="generic"
          CONFIG_TARGET_ARCH_PACKAGES=""
          CONFIG_DEFAULT_TARGET_OPTIMIZATION="-Os -pipe -march=x86-64"
          CONFIG_TARGET_OPTIMIZATION="-Os -pipe -march=x86-64"
          CONFIG_LIBC="musl"
          CONFIG_LIBC_VERSION="1.2.4"
          CONFIG_TARGET_SUFFIX="generic"
          CONFIG_USE_SSTRIP=y
          CONFIG_STRIP_ARGS="--strip-all"
          CONFIG_USE_MKLIBS=y
          CONFIG_PACKAGE_libgpiod=y
          CONFIG_PACKAGE_libjson-c=y
          CONFIG_PACKAGE_libpthread=y
          EOF
          
          # Make defconfig
          make defconfig

      - name: Copy package source
        run: |
          cd $SDK_DIR
          
          # Create package directory
          mkdir -p package/gpio-fan-rpm
          
          # Copy package files
          cp -r $GITHUB_WORKSPACE/* package/gpio-fan-rpm/
          
          # Show package structure
          echo "Package structure:"
          find package/gpio-fan-rpm -type f -name "*.c" -o -name "*.h" -o -name "Makefile" -o -name "Kconfig" | sort

      - name: Build package
        run: |
          cd $SDK_DIR
          
          echo "Building gpio-fan-rpm package for OpenWRT ${{ github.event.inputs.openwrt_version }}..."
          
          # Build the package (verbose only if requested)
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            echo "Building with verbose output..."
            make package/gpio-fan-rpm/compile V=s
          else
            echo "Building with standard output..."
            make package/gpio-fan-rpm/compile
          fi
          
          # Check if build was successful
          if [ $? -eq 0 ]; then
            echo "✅ Build successful!"
            
            # List generated packages
            echo "Generated packages:"
            find bin/packages -name "*gpio-fan-rpm*" -type f
            
            # Show package info
            if [ -f bin/packages/*/base/gpio-fan-rpm_*.ipk ]; then
              echo "Package details:"
              tar -tzf bin/packages/*/base/gpio-fan-rpm_*.ipk | head -10
              
              echo "Package size:"
              du -h bin/packages/*/base/gpio-fan-rpm_*.ipk
            fi
          else
            echo "❌ Build failed!"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-test-${{ github.event.inputs.openwrt_version }}-${{ github.run_id }}
          path: |
            ${{ env.SDK_DIR }}/bin/packages/*/base/gpio-fan-rpm_*.ipk
            ${{ env.SDK_DIR }}/bin/packages/*/base/Packages*
          retention-days: 7

      - name: Build summary
        if: always()
        run: |
          echo "## Build Test Summary for OpenWRT ${{ github.event.inputs.openwrt_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f $SDK_DIR/bin/packages/*/base/gpio-fan-rpm_*.ipk ]; then
            echo "✅ **Build Status**: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Generated Package**: " >> $GITHUB_STEP_SUMMARY
            ls -la $SDK_DIR/bin/packages/*/base/gpio-fan-rpm_*.ipk >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Package Size**: " >> $GITHUB_STEP_SUMMARY
            du -h $SDK_DIR/bin/packages/*/base/gpio-fan-rpm_*.ipk >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Architecture**: $TARGET_ARCH" >> $GITHUB_STEP_SUMMARY
            echo "**OpenWRT Version**: ${{ github.event.inputs.openwrt_version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Verbose Mode**: ${{ github.event.inputs.verbose }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Build Status**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No package was generated." >> $GITHUB_STEP_SUMMARY
          fi 